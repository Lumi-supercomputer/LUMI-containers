Bootstrap: oras
From: ghcr.io/lumi-supercomputer/vnc:1.0

%post
    VGL_VERSION=3.0.2
    NVIDIA_DRIVER_VERSION=515.105.01

    cd /
    wget -O VirtualGL-${VGL_VERSION}.x86_64.rpm https://sourceforge.net/projects/virtualgl/files/${VGL_VERSION}/VirtualGL-${VGL_VERSION}.x86_64.rpm/download
    zypper -n install libXv1
    zypper -n install Mesa-libGL1
    zypper -n install Mesa-libEGL1 libGLU1
    zypper -n install libglvnd libglvnd-devel
    zypper -n install xorg-x11-xauth xterm libXtst6
    zypper -n install xorg-x11-fonts
    zypper -n install kmod
    rpm -i /VirtualGL-${VGL_VERSION}.x86_64.rpm
    wget https://us.download.nvidia.com/tesla/${NVIDIA_DRIVER_VERSION}/NVIDIA-Linux-x86_64-${NVIDIA_DRIVER_VERSION}.run
    sh NVIDIA-Linux-x86_64-${NVIDIA_DRIVER_VERSION}.run -a -N --ui=none --no-kernel-module --no-x-check
    zypper -n install libturbojpeg0
    vglserver_config +s +f +t +glx
